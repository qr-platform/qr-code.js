import{Resvg as e}from"@resvg/resvg-js";import{Image as t}from"image-js";import r from"@undecaf/zbar-wasm/dist/zbar.wasm?module";const n=async(e,t)=>{try{t(await WebAssembly.instantiate(r,e),r)}catch(e){throw console.error("Zbar WASM: Error during instantiation:",e),e}},i=function(e){function t(e,t,r,n){return new(r||(r=Promise))((function(t,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function o(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(a,o)}s((n=n.apply(e,[])).next())}))}function r(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var r=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})})),r}"function"==typeof SuppressedError&&SuppressedError;var n={exports:{}};const i=r(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));function a(e,t){for(var r=0,n=e.length-1;n>=0;n--){var i=e[n];"."===i?e.splice(n,1):".."===i?(e.splice(n,1),r++):r&&(e.splice(n,1),r--)}if(t)for(;r--;r)e.unshift("..");return e}var o=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,s=function(e){return o.exec(e).slice(1)};function c(){for(var e="",t=!1,r=arguments.length-1;r>=-1&&!t;r--){var n=r>=0?arguments[r]:"/";if("string"!=typeof n)throw new TypeError("Arguments to path.resolve must be strings");n&&(e=n+"/"+e,t="/"===n.charAt(0))}return(t?"/":"")+(e=a(g(e.split("/"),(function(e){return!!e})),!t).join("/"))||"."}function u(e){var t=l(e),r="/"===p(e,-1);return(e=a(g(e.split("/"),(function(e){return!!e})),!t).join("/"))||t||(e="."),e&&r&&(e+="/"),(t?"/":"")+e}function l(e){return"/"===e.charAt(0)}function f(){return u(g(Array.prototype.slice.call(arguments,0),(function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e})).join("/"))}function d(e,t){function r(e){for(var t=0;t<e.length&&""===e[t];t++);for(var r=e.length-1;r>=0&&""===e[r];r--);return t>r?[]:e.slice(t,r-t+1)}e=c(e).substr(1),t=c(t).substr(1);for(var n=r(e.split("/")),i=r(t.split("/")),a=Math.min(n.length,i.length),o=a,s=0;s<a;s++)if(n[s]!==i[s]){o=s;break}var u=[];for(s=o;s<n.length;s++)u.push("..");return(u=u.concat(i.slice(o))).join("/")}function h(e){var t=s(e),r=t[0],n=t[1];return r||n?(n&&(n=n.substr(0,n.length-1)),r+n):"."}function _(e,t){var r=s(e)[2];return t&&r.substr(-1*t.length)===t&&(r=r.substr(0,r.length-t.length)),r}function m(e){return s(e)[3]}const A={extname:m,basename:_,dirname:h,sep:"/",delimiter:":",relative:d,join:f,isAbsolute:l,normalize:u,resolve:c};function g(e,t){if(e.filter)return e.filter(t);for(var r=[],n=0;n<e.length;n++)t(e[n],n,e)&&r.push(e[n]);return r}var p="b"==="ab".substr(-1)?function(e,t,r){return e.substr(t,r)}:function(e,t,r){return t<0&&(t=e.length+t),e.substr(t,r)};const y=r(Object.freeze(Object.defineProperty({__proto__:null,basename:_,default:A,delimiter:":",dirname:h,extname:m,isAbsolute:l,join:f,normalize:u,relative:d,resolve:c,sep:"/"},Symbol.toStringTag,{value:"Module"})));!function(e){var t,r=(t="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,"undefined"!=typeof __filename&&(t=t||__filename),function(e={}){var r,n,a=e;a.ready=new Promise(((e,t)=>{r=e,n=t}));var o,s,c,u=Object.assign({},a),l="object"==typeof window,f="function"==typeof importScripts,d="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,h="";if(d){var _=i,m=y;h=f?m.dirname(h)+"/":__dirname+"/",o=(e,t)=>(e=F(e)?new URL(e):m.normalize(e),_.readFileSync(e,t?void 0:"utf8")),c=e=>{var t=o(e,!0);return t.buffer||(t=new Uint8Array(t)),t},s=(e,t,r,n=!0)=>{e=F(e)?new URL(e):m.normalize(e),_.readFile(e,n?void 0:"utf8",((e,i)=>{e?r(e):t(n?i.buffer:i)}))},!a.thisProgram&&process.argv.length>1&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),a.inspect=()=>"[Emscripten Module object]"}else(l||f)&&(f?h=self.location.href:"undefined"!=typeof document&&document.currentScript&&(h=document.currentScript.src),t&&(h=t),h=0!==h.indexOf("blob:")?h.substr(0,h.replace(/[?#].*/,"").lastIndexOf("/")+1):"",o=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},f&&(c=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),s=(e,t,r)=>{var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=()=>{200==n.status||0==n.status&&n.response?t(n.response):r()},n.onerror=r,n.send(null)});var A,g,p,R=a.print||console.log.bind(console),E=a.printErr||console.error.bind(console);Object.assign(a,u),u=null,a.arguments&&a.arguments,a.thisProgram&&a.thisProgram,a.quit&&a.quit,a.wasmBinary&&(A=a.wasmBinary),a.noExitRuntime,"object"!=typeof WebAssembly&&T("no native wasm support detected");var v,B,b=!1;function I(){var e=g.buffer;a.HEAP8=new Int8Array(e),a.HEAP16=new Int16Array(e),a.HEAP32=new Int32Array(e),a.HEAPU8=v=new Uint8Array(e),a.HEAPU16=new Uint16Array(e),a.HEAPU32=B=new Uint32Array(e),a.HEAPF32=new Float32Array(e),a.HEAPF64=new Float64Array(e)}var w=[],Z=[],S=[],C=0,N=null;function T(e){a.onAbort&&a.onAbort(e),E(e="Aborted("+e+")"),b=!0,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw n(t),t}var D,O;function P(e){return e.startsWith("data:application/octet-stream;base64,")}function F(e){return e.startsWith("file://")}function G(e){if(e==D&&A)return new Uint8Array(A);if(c)return c(e);throw"both async and sync fetching of the wasm failed"}function U(e,t,r){return function(e){if(!A&&(l||f)){if("function"==typeof fetch&&!F(e))return fetch(e,{credentials:"same-origin"}).then((t=>{if(!t.ok)throw"failed to load wasm binary file at '"+e+"'";return t.arrayBuffer()})).catch((()=>G(e)));if(s)return new Promise(((t,r)=>{s(e,(e=>t(new Uint8Array(e))),r)}))}return Promise.resolve().then((()=>G(e)))}(e).then((e=>WebAssembly.instantiate(e,t))).then((e=>e)).then(r,(e=>{E("failed to asynchronously prepare wasm: "+e),T(e)}))}P(D="zbar.wasm")||(O=D,D=a.locateFile?a.locateFile(O,h):h+O);var x,H=e=>{for(;e.length>0;)e.shift()(a)},M=e=>{var t=e-g.buffer.byteLength+65535>>>16;try{return g.grow(t),I(),1}catch(e){}},$="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0,j=[null,[],[]],L=(e,t)=>{var r=j[e];0===t||10===t?((1===e?R:E)(((e,t)=>{for(var r=t+void 0,n=t;e[n]&&!(n>=r);)++n;if(n-t>16&&e.buffer&&$)return $.decode(e.subarray(t,n));for(var i="";t<n;){var a=e[t++];if(128&a){var o=63&e[t++];if(192!=(224&a)){var s=63&e[t++];if((a=224==(240&a)?(15&a)<<12|o<<6|s:(7&a)<<18|o<<12|s<<6|63&e[t++])<65536)i+=String.fromCharCode(a);else{var c=a-65536;i+=String.fromCharCode(55296|c>>10,56320|1023&c)}}else i+=String.fromCharCode((31&a)<<6|o)}else i+=String.fromCharCode(a)}return i})(r,0)),r.length=0):r.push(t)},W={d:()=>!0,e:function(){return Date.now()},c:e=>{var t=v.length,r=2147483648;if((e>>>=0)>r)return!1;for(var n,i=1;i<=4;i*=2){var a=t*(1+.2/i);a=Math.min(a,e+100663296);var o=Math.min(r,(n=Math.max(e,a))+(65536-n%65536)%65536);if(M(o))return!0}return!1},f:e=>52,b:function(e,t,r,n,i){return 70},a:(e,t,r,n)=>{for(var i=0,a=0;a<r;a++){var o=B[t>>2],s=B[t+4>>2];t+=8;for(var c=0;c<s;c++)L(e,v[o+c]);i+=s}return B[n>>2]=i,0}};function k(){function e(){x||(x=!0,a.calledRun=!0,b||(H(Z),r(a),a.onRuntimeInitialized&&a.onRuntimeInitialized(),function(){if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=[a.postRun]);a.postRun.length;)e=a.postRun.shift(),S.unshift(e);var e;H(S)}()))}C>0||(function(){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)e=a.preRun.shift(),w.unshift(e);var e;H(w)}(),C>0||(a.setStatus?(a.setStatus("Running..."),setTimeout((function(){setTimeout((function(){a.setStatus("")}),1),e()}),1)):e()))}if(function(){var e,t,r,i,o={a:W};function s(e,t){var r,n=e.exports;return g=(p=n).g,I(),p.s,r=p.h,Z.unshift(r),function(){if(C--,a.monitorRunDependencies&&a.monitorRunDependencies(C),0==C&&N){var e=N;N=null,e()}}(),n}if(C++,a.monitorRunDependencies&&a.monitorRunDependencies(C),a.instantiateWasm)try{return a.instantiateWasm(o,s)}catch(e){E("Module.instantiateWasm callback failed with error: "+e),n(e)}(e=A,t=D,r=o,i=function(e){s(e.instance)},e||"function"!=typeof WebAssembly.instantiateStreaming||P(t)||F(t)||d||"function"!=typeof fetch?U(t,r,i):fetch(t,{credentials:"same-origin"}).then((e=>WebAssembly.instantiateStreaming(e,r).then(i,(function(e){return E("wasm streaming compile failed: "+e),E("falling back to ArrayBuffer instantiation"),U(t,r,i)}))))).catch(n)}(),a._ImageScanner_create=()=>(a._ImageScanner_create=p.i)(),a._ImageScanner_destory=e=>(a._ImageScanner_destory=p.j)(e),a._ImageScanner_set_config=(e,t,r,n)=>(a._ImageScanner_set_config=p.k)(e,t,r,n),a._ImageScanner_enable_cache=(e,t)=>(a._ImageScanner_enable_cache=p.l)(e,t),a._ImageScanner_recycle_image=(e,t)=>(a._ImageScanner_recycle_image=p.m)(e,t),a._ImageScanner_get_results=e=>(a._ImageScanner_get_results=p.n)(e),a._ImageScanner_scan=(e,t)=>(a._ImageScanner_scan=p.o)(e,t),a._Image_create=(e,t,r,n,i,o)=>(a._Image_create=p.p)(e,t,r,n,i,o),a._Image_destory=e=>(a._Image_destory=p.q)(e),a._Image_get_symbols=e=>(a._Image_get_symbols=p.r)(e),a._free=e=>(a._free=p.t)(e),a._malloc=e=>(a._malloc=p.u)(e),N=function e(){x||k(),x||(N=e)},a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.pop()();return k(),e.ready});e.exports=r}(n);const R=function(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}(n.exports);let E;function v(e={}){E=function(){return t(this,0,void 0,(function*(){const t=yield R(e);if(t)return t;throw Error("WASM was not loaded")}))}()}function B(){return t(this,0,void 0,(function*(){return E||v(),yield E}))}var b,I,w;e.ZBarSymbolType=void 0,(b=e.ZBarSymbolType||(e.ZBarSymbolType={}))[b.ZBAR_NONE=0]="ZBAR_NONE",b[b.ZBAR_PARTIAL=1]="ZBAR_PARTIAL",b[b.ZBAR_EAN2=2]="ZBAR_EAN2",b[b.ZBAR_EAN5=5]="ZBAR_EAN5",b[b.ZBAR_EAN8=8]="ZBAR_EAN8",b[b.ZBAR_UPCE=9]="ZBAR_UPCE",b[b.ZBAR_ISBN10=10]="ZBAR_ISBN10",b[b.ZBAR_UPCA=12]="ZBAR_UPCA",b[b.ZBAR_EAN13=13]="ZBAR_EAN13",b[b.ZBAR_ISBN13=14]="ZBAR_ISBN13",b[b.ZBAR_COMPOSITE=15]="ZBAR_COMPOSITE",b[b.ZBAR_I25=25]="ZBAR_I25",b[b.ZBAR_DATABAR=34]="ZBAR_DATABAR",b[b.ZBAR_DATABAR_EXP=35]="ZBAR_DATABAR_EXP",b[b.ZBAR_CODABAR=38]="ZBAR_CODABAR",b[b.ZBAR_CODE39=39]="ZBAR_CODE39",b[b.ZBAR_PDF417=57]="ZBAR_PDF417",b[b.ZBAR_QRCODE=64]="ZBAR_QRCODE",b[b.ZBAR_SQCODE=80]="ZBAR_SQCODE",b[b.ZBAR_CODE93=93]="ZBAR_CODE93",b[b.ZBAR_CODE128=128]="ZBAR_CODE128",b[b.ZBAR_SYMBOL=255]="ZBAR_SYMBOL",b[b.ZBAR_ADDON2=512]="ZBAR_ADDON2",b[b.ZBAR_ADDON5=1280]="ZBAR_ADDON5",b[b.ZBAR_ADDON=1792]="ZBAR_ADDON",e.ZBarConfigType=void 0,(I=e.ZBarConfigType||(e.ZBarConfigType={}))[I.ZBAR_CFG_ENABLE=0]="ZBAR_CFG_ENABLE",I[I.ZBAR_CFG_ADD_CHECK=1]="ZBAR_CFG_ADD_CHECK",I[I.ZBAR_CFG_EMIT_CHECK=2]="ZBAR_CFG_EMIT_CHECK",I[I.ZBAR_CFG_ASCII=3]="ZBAR_CFG_ASCII",I[I.ZBAR_CFG_BINARY=4]="ZBAR_CFG_BINARY",I[I.ZBAR_CFG_NUM=5]="ZBAR_CFG_NUM",I[I.ZBAR_CFG_MIN_LEN=32]="ZBAR_CFG_MIN_LEN",I[I.ZBAR_CFG_MAX_LEN=33]="ZBAR_CFG_MAX_LEN",I[I.ZBAR_CFG_UNCERTAINTY=64]="ZBAR_CFG_UNCERTAINTY",I[I.ZBAR_CFG_POSITION=128]="ZBAR_CFG_POSITION",I[I.ZBAR_CFG_TEST_INVERTED=129]="ZBAR_CFG_TEST_INVERTED",I[I.ZBAR_CFG_X_DENSITY=256]="ZBAR_CFG_X_DENSITY",I[I.ZBAR_CFG_Y_DENSITY=257]="ZBAR_CFG_Y_DENSITY",e.ZBarOrientation=void 0,(w=e.ZBarOrientation||(e.ZBarOrientation={}))[w.ZBAR_ORIENT_UNKNOWN=-1]="ZBAR_ORIENT_UNKNOWN",w[w.ZBAR_ORIENT_UP=0]="ZBAR_ORIENT_UP",w[w.ZBAR_ORIENT_RIGHT=1]="ZBAR_ORIENT_RIGHT",w[w.ZBAR_ORIENT_DOWN=2]="ZBAR_ORIENT_DOWN",w[w.ZBAR_ORIENT_LEFT=3]="ZBAR_ORIENT_LEFT";class Z{constructor(e,t){this.ptr=e,this.inst=t}checkAlive(){if(!this.ptr)throw Error("Call after destroyed")}getPointer(){return this.checkAlive(),this.ptr}}class S{constructor(e,t){this.ptr=e,this.ptr32=e>>2,this.buf=t,this.HEAP8=new Int8Array(t),this.HEAPU32=new Uint32Array(t),this.HEAP32=new Int32Array(t)}}class C extends S{get type(){return this.HEAPU32[this.ptr32]}get data(){const e=this.HEAPU32[this.ptr32+4],t=this.HEAPU32[this.ptr32+5];return Int8Array.from(this.HEAP8.subarray(t,t+e))}get points(){const e=this.HEAPU32[this.ptr32+7],t=this.HEAPU32[this.ptr32+8]>>2,r=[];for(let n=0;n<e;++n){const e=this.HEAP32[t+2*n],i=this.HEAP32[t+2*n+1];r.push({x:e,y:i})}return r}get orientation(){return this.HEAP32[this.ptr32+9]}get next(){const e=this.HEAPU32[this.ptr32+11];return e?new C(e,this.buf):null}get time(){return this.HEAPU32[this.ptr32+13]}get cacheCount(){return this.HEAP32[this.ptr32+14]}get quality(){return this.HEAP32[this.ptr32+15]}}class N extends S{get head(){const e=this.HEAPU32[this.ptr32+2];return e?new C(e,this.buf):null}}class T{constructor(t){this.type=t.type,this.typeName=e.ZBarSymbolType[this.type],this.data=t.data,this.points=t.points,this.orientation=t.orientation,this.time=t.time,this.cacheCount=t.cacheCount,this.quality=t.quality}static createSymbolsFromPtr(e,t){if(0==e)return[];let r=new N(e,t).head;const n=[];for(;null!==r;)n.push(new T(r)),r=r.next;return n}decode(e){return new TextDecoder(e).decode(this.data)}}class D extends Z{static createFromGrayBuffer(e,r,n,i=0){return t(this,0,void 0,(function*(){const t=yield B(),a=new Uint8Array(n),o=e*r;if(o!==a.byteLength)throw Error(`data length (${a.byteLength} bytes) does not match width and height (${o} bytes)`);const s=t._malloc(o);return t.HEAPU8.set(a,s),new this(t._Image_create(e,r,808466521,s,o,i),t)}))}static createFromRGBABuffer(e,r,n,i=0){return t(this,0,void 0,(function*(){const t=yield B(),a=new Uint8Array(n),o=e*r;if(4*o!==a.byteLength)throw Error(`data length (${a.byteLength} bytes) does not match width and height (${4*o} bytes)`);const s=t._malloc(o),c=s+o,u=t.HEAPU8;for(let e=s,t=0;e<c;e++,t+=4)u[e]=19595*a[t]+38469*a[t+1]+7472*a[t+2]>>16;return new this(t._Image_create(e,r,808466521,s,o,i),t)}))}destroy(){this.checkAlive(),this.inst._Image_destory(this.ptr),this.ptr=0}getSymbols(){this.checkAlive();const e=this.inst._Image_get_symbols(this.ptr);return T.createSymbolsFromPtr(e,this.inst.HEAPU8.buffer)}}class O extends Z{static create(){return t(this,0,void 0,(function*(){const e=yield B();return new this(e._ImageScanner_create(),e)}))}destroy(){this.checkAlive(),this.inst._ImageScanner_destory(this.ptr),this.ptr=0}setConfig(e,t,r){return this.checkAlive(),this.inst._ImageScanner_set_config(this.ptr,e,t,r)}enableCache(e=!0){this.checkAlive(),this.inst._ImageScanner_enable_cache(this.ptr,e)}recycleImage(e){this.checkAlive(),this.inst._ImageScanner_recycle_image(this.ptr,e.getPointer())}getResults(){this.checkAlive();const e=this.inst._ImageScanner_get_results(this.ptr);return T.createSymbolsFromPtr(e,this.inst.HEAPU8.buffer)}scan(e){return this.checkAlive(),this.inst._ImageScanner_scan(this.ptr,e.getPointer())}}const P=()=>t(void 0,0,void 0,(function*(){const t=yield O.create();return t.setConfig(e.ZBarSymbolType.ZBAR_NONE,e.ZBarConfigType.ZBAR_CFG_BINARY,1),t}));let F;const G=(e,r)=>t(void 0,0,void 0,(function*(){void 0===r&&(r=F||(yield P()),F=r);const t=r.scan(e);if(t<0)throw Error("Scan Failed");return 0===t?[]:e.getSymbols()})),U=(e,r,n,i)=>t(void 0,0,void 0,(function*(){const t=yield D.createFromRGBABuffer(r,n,e),a=yield G(t,i);return t.destroy(),a}));return e.ZBarImage=D,e.ZBarScanner=O,e.ZBarSymbol=T,e.getDefaultScanner=P,e.getInstance=B,e.scanGrayBuffer=(e,r,n,i)=>t(void 0,0,void 0,(function*(){const t=yield D.createFromGrayBuffer(r,n,e),a=yield G(t,i);return t.destroy(),a})),e.scanImageData=(e,r)=>t(void 0,0,void 0,(function*(){return yield U(e.data.buffer,e.width,e.height,r)})),e.scanRGBABuffer=U,e.setModuleArgs=v,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});i.setModuleArgs&&i.setModuleArgs({instantiateWasm:n});let a=!1;const o=e=>{a&&console.debug("[QR Validator]",e)},s=new class{constructor(e={}){this.maxRetries=e.maxRetries??5,this.retryInterval=e.retryInterval??100,this.debug=e.debug??!1}log(e){this.debug&&console.log(`[QRValidatorZbarNode] ${e}`)}async validate(e,t=!1){try{if(!i.scanImageData)throw new Error("zbar-wasm library not found. Please ensure @undecaf/zbar-wasm is installed and loaded correctly.");return this.validateWithRetry(e,t)}catch(e){return this.log(`Validation error: ${e instanceof Error?e.message:String(e)}`),{isValid:!1,error:e instanceof Error?e.message:String(e),errorCode:"VALIDATION_ERROR"}}}sleep(e){return new Promise((t=>setTimeout(t,e)))}async processImageResvg(t,r){try{const n=new e(t,{fitTo:{mode:"zoom",value:2}}).render(),i=n.width,a=n.height,o=n.pixels,s=Buffer.from(o);if(r)for(let e=0;e<s.length;e+=4)s[e]=255-s[e],s[e+1]=255-s[e+1],s[e+2]=255-s[e+2];return{imageData:{data:new Uint8ClampedArray(s),width:i,height:a},metadata:{width:i,height:a}}}catch(e){throw this.log(`Image processing error: ${e instanceof Error?e.message:String(e)}`),e}}async validateWithRetry(e,t){let r=0,n=null;const i=e;let a=!1;do{r++;try{const e=this.processImageResvg,{imageData:o}=await e(i,t);if(this.log(`Processed image ${o.width}x${o.height} pixels`),this.debug&&await this.saveDebugImage(o,`debug/qr-attempt-${r}-${a?"inverted":"normal"}`),n=await this.decodeQR(o),this.log(`Barcode scan attempt ${r}: ${n.success?"Success":"Failed"}`),n.success)return n.attempts=r,{isValid:!0,data:n.data,format:n.format,attempts:r,isInverted:t}}catch(e){this.log(`Attempt ${r} failed: ${e instanceof Error?e.message:String(e)}`),n={success:!1,error:e instanceof Error?e.message:String(e),errorCode:"PROCESSING_ERROR"}}!t||a?r<this.maxRetries&&await this.sleep(this.retryInterval):(a=!0,this.log("Switching to inverted image for next attempt"))}while(r<this.maxRetries);return{isValid:!1,attempts:r,error:`No barcode detected after ${r} attempts`,errorCode:"MAX_RETRIES_EXCEEDED"}}async saveDebugImage(e,r){try{const n=new t(e.width,e.height,e.data,{kind:"RGBA"}),i=`${r}-${Date.now()}`;await n.save(`${i}.png`,{format:"png"}),this.log(`Debug image saved to: ${i}`)}catch(e){this.log(`Failed to save debug image: ${e instanceof Error?e.message:String(e)}`)}}async decodeQR(e){try{let t;try{t=await i.scanImageData(e)}catch(e){this.log(`Error decoding QR code: ${e}`)}if(t&&t.length>0){const e=t[0],r=e.decode();return this.log(`Detected: ${e.typeName} - ${r}`),{success:!0,data:r,format:e.typeName||"UNKNOWN",confidence:.9,count:t.length,allSymbols:t.map((e=>({data:e.decode(),type:e.typeName,points:e.points})))}}return{success:!1,error:"No barcode detected",errorCode:"NO_BARCODE_DETECTED"}}catch(e){return this.log("Decoder error:"),console.error(e instanceof Error?e.message:String(e)),{success:!1,error:`Decoder error: ${e instanceof Error?e.message:String(e)}`,errorCode:"DECODER_ERROR"}}}}({maxRetries:3,debug:!1,retryInterval:300}),c={validateZbar:async(e,t=!1)=>{a=t||a,a&&console.time("scan-validator");const r=[{name:"Normal SVG",execute:async()=>{if(!e)throw new Error("No svg source");const t=await s.validate(e,!1);if(!t.isValid||!t.data)throw new Error("No text found in normal QR code");return{isValid:!0,isInverted:!1,decodedText:t.data,message:"Decoded successfully.",attempts:t.attempts}}},{name:"Inverted SVG",execute:async()=>{if(!e)throw new Error("No svg source for inverted attempt");const t=await s.validate(e,!0);if(!t.isValid||!t.data)throw new Error("No text found in inverted QR code");return{isValid:!0,isInverted:!0,decodedText:t.data,message:"Decoded successfully (inverted).",attempts:t.attempts}}}];for(const e of r)try{o(`Trying ${e.name} decode...`);const t=await e.execute();return a&&console.timeEnd("scan-validator"),t}catch(t){o(`${e.name} decode failed:`),o(t)}return a&&console.timeEnd("scan-validator"),{isValid:!1,message:"Failed to decode QR code after all attempts."}}};export{c as qrValidator};
